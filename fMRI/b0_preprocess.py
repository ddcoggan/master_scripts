#!/usr/bin/env python# based on guides at https://fsl.fmrib.ox.ac.uk/fsl/fslwiki/FUGUE/Guide#Non-SIEMENS_data and https://osf.io/hks7x and https://www.google.com/url?sa=t&rct=j&q=&esrc=s&source=web&cd=&ved=2ahUKEwjJlbLj16T-AhVFtIkEHUIhBIYQFnoECAwQAQ&url=https%3A%2F%2Fosf.io%2Fhks7x%2Fdownload&usg=AOvVaw2jUUkNYoKjJ8Ta-OJti5hkimport os.path as opimport osimport numpy as npdef b0_preprocess(b0dir, mag_path, real_path):    # preprocessing magnitude image    # link to raw data    mag_link = f'{b0dir}/b0_mag.nii'    if not os.path.isfile(mag_link):        os.system(f'ln -s {op.abspath(mag_path)} {op.abspath(mag_link)}')    # brain extraction    mag_brain = f"{mag_link[:-4]}_brain.nii.gz"    os.system(f'bet {mag_link} {mag_brain}')    # erode noisy voxel from edges (overwrite file for FSL compatibility)    os.system(f'fslmaths {mag_brain} -ero {mag_brain}')        # preprocessing real field map image    # link to raw data    real_link = f'{b0dir}/b0_real.nii'    if not os.path.isfile(real_link):        os.system(f'ln -s {op.abspath(real_path)} {op.abspath(real_link)}')    # rescale from Hz (indicated by range of +/- 500) to radians (by scaling by 2pi)    real_rads = f'{real_link[:-4]}_rads.nii.gz'    os.system(f'fslmaths {real_link} -mul {np.pi*2} {real_rads}')    # regularization by median filtering    real_reg = f'{real_rads[:-7]}_reg.nii.gz'    os.system(f'fugue --loadfmap={real_rads} -m --savefmap={real_reg}')def b0_apply(epi_path, fieldmap_path, out_path):    # preprocessing magnitude image    os.system(        f'fugue -i {in_path} --dwell={ees} --loadfmap={real_path_copy[:-7]}_rads_reg_unwarped.nii.gz --unwarpdir=y- --asym={te} --despike -u {out_path}')